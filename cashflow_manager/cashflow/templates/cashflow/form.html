{% extends 'cashflow/base.html' %}

{% load form_tags %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>{% if object %}Редактировать запись{% else %}Создать запись{% endif %}</h2>
    <a href="{% url 'cashflow:list' %}" class="btn btn-secondary">
        <i class="bi bi-arrow-left me-1"></i> Назад
    </a>
</div>

<div class="form-container">
    <form method="post" class="needs-validation" novalidate>
        {% csrf_token %}

        <div class="row g-3">
            <!-- Дата -->
            <div class="col-md-4">
                <label for="id_date" class="form-label">Дата</label>
                {{ form.date|add_class:"form-control" }}
                <div class="invalid-feedback">Пожалуйста, укажите дату.</div>
            </div>

            <!-- Статус -->
            <div class="col-md-4">
                <label for="id_status" class="form-label">Статус</label>
                {{ form.status|add_class:"form-select" }}
                <div class="invalid-feedback">Пожалуйста, выберите статус.</div>
            </div>

            <!-- Тип -->
            <div class="col-md-4">
                <label for="id_type" class="form-label">Тип</label>
                {{ form.type|add_class:"form-select" }}
                <div class="invalid-feedback">Пожалуйста, выберите тип.</div>
            </div>

            <!-- Категория -->
            <div class="col-md-4">
                <label for="id_category" class="form-label">Категория</label>
                {{ form.category|add_class:"form-select" }}
                <div class="invalid-feedback">Пожалуйста, выберите категорию.</div>
            </div>

            <!-- Подкатегория -->
            <div class="col-md-4">
                <label for="id_subcategory" class="form-label">Подкатегория</label>
                {{ form.subcategory|add_class:"form-select" }}
                <div class="invalid-feedback">Пожалуйста, выберите подкатегорию.</div>
            </div>

            <!-- Сумма -->
            <div class="col-md-4">
                <label for="id_amount" class="form-label">Сумма (₽)</label>
                {{ form.amount|add_class:"form-control" }}
                <div class="invalid-feedback">Пожалуйста, укажите сумму.</div>
            </div>

            <!-- Комментарий -->
            <div class="col-12">
                <label for="id_comment" class="form-label">Комментарий</label>
                {{ form.comment|add_class:"form-control"|attr:"rows:3" }}
            </div>
        </div>

        <div class="mt-4 d-flex justify-content-end">
            <button type="submit" class="btn btn-primary me-2">
                <i class="bi bi-save me-1"></i> Сохранить
            </button>
            <a href="{% url 'cashflow:list' %}" class="btn btn-outline-secondary">
                <i class="bi bi-x me-1"></i> Отмена
            </a>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        // Динамическая фильтрация подкатегорий при выборе категории
        $("#id_category").change(function() {
            var categoryId = $(this).val();
            if (categoryId) {
                $.ajax({
                    url: "/api/subcategories/?category=" + categoryId,
                    success: function(data) {
                        var options = '<option value="">---------</option>';
                        data.forEach(function(subcategory) {
                            options += '<option value="' + subcategory.id + '">' + subcategory.name + '</option>';
                        });
                        $("#id_subcategory").html(options);
                    },
                    error: function(xhr, status, error) {
                        console.error("Error fetching subcategories:", error);
                    }
                });
            } else {
                $("#id_subcategory").html('<option value="">---------</option>');
            }
        });
    });
</script>
{% endblock %}
